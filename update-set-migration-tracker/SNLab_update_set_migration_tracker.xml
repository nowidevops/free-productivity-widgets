<?xml version="1.0" encoding="UTF-8"?>
<unload unload_date="2026-02-11 03:53:03">
<sp_widget action="INSERT_OR_UPDATE">
<category>custom</category>
<client_script><![CDATA[api.controller = function($scope, $interval, $timeout, spUtil, spModal, $window) {
  var c = this;

  // Initialize state
  c.loading = false;
  c.errorMessage = '';
  c.searchTerm = '';
  c.expandedRows = {};
  c.loadingDetails = {};
  c.sortField = 'sys_updated_on';
  c.sortReverse = true;
  c.autoRefreshEnabled = true;
  c.lastRefreshed = '';
  c.filteredSets = [];
  var autoRefreshInterval = null;

  c.filters = {
    state: '',
    dateFrom: null,
    dateTo: null,
    creator: ''
  };

  // Initialize data defaults
  if (!c.data) c.data = {};
  if (!c.data.updateSets) c.data.updateSets = [];
  if (!c.data.stats) c.data.stats = {};
  if (!c.data.creators) c.data.creators = [];
  c.data.currentPage = c.data.currentPage || 1;
  c.data.totalPages = c.data.totalPages || 1;

  c.lastRefreshed = new Date().toLocaleTimeString();

  // Start auto-refresh
  function startAutoRefresh() {
    stopAutoRefresh();
    autoRefreshInterval = $interval(function() {
      c.refreshData();
    }, 60000);
  }

  function stopAutoRefresh() {
    if (autoRefreshInterval) {
      $interval.cancel(autoRefreshInterval);
      autoRefreshInterval = null;
    }
  }

  c.toggleAutoRefresh = function() {
    if (c.autoRefreshEnabled) {
      startAutoRefresh();
    } else {
      stopAutoRefresh();
    }
  };

  if (c.autoRefreshEnabled) {
    startAutoRefresh();
  }

  // Cleanup on destroy
  $scope.$on('$destroy', function() {
    stopAutoRefresh();
  });

  // Refresh data from server
  c.refreshData = function() {
    c.loading = true;
    c.errorMessage = '';

    var params = {
      action: 'fetchUpdateSets',
      state: c.filters.state || '',
      dateFrom: c.filters.dateFrom ? formatDateForServer(c.filters.dateFrom) : '',
      dateTo: c.filters.dateTo ? formatDateForServer(c.filters.dateTo) : '',
      creator: c.filters.creator || '',
      page: c.data.currentPage || 1,
      pageSize: 50
    };

    c.server.get(params).then(function(response) {
      var data = response.data;
      if (data.accessDenied) {
        c.data.accessDenied = true;
        c.loading = false;
        return;
      }
      c.data.updateSets = data.updateSets || [];
      c.data.stats = data.stats || {};
      c.data.creators = data.creators || [];
      c.data.totalPages = data.totalPages || 1;
      c.data.currentPage = data.currentPage || 1;
      c.data.avgMigrationTime = data.avgMigrationTime || '';
      c.lastRefreshed = new Date().toLocaleTimeString();
      c.loading = false;
    }, function(error) {
      c.errorMessage = 'Failed to load update set data. Please try again.';
      c.loading = false;
    });
  };

  function formatDateForServer(dateObj) {
    if (!dateObj) return '';
    if (typeof dateObj === 'string') return dateObj;
    var d = new Date(dateObj);
    var month = ('0' + (d.getMonth() + 1)).slice(-2);
    var day = ('0' + d.getDate()).slice(-2);
    return d.getFullYear() + '-' + month + '-' + day;
  }

  // Apply filters
  c.applyFilters = function() {
    c.data.currentPage = 1;
    c.refreshData();
  };

  c.onSearchChange = function() {
    // Client-side search is handled by the filter in ng-repeat
  };

  c.clearSearch = function() {
    c.searchTerm = '';
  };

  // Client-side search filter function
  c.searchFilter = function(item) {
    if (!c.searchTerm || c.searchTerm.trim() === '') return true;
    var term = c.searchTerm.toLowerCase();
    var name = (item.name || '').toLowerCase();
    var desc = (item.description || '').toLowerCase();
    var creator = (item.sys_created_by || '').toLowerCase();
    return name.indexOf(term) !== -1 ||
           desc.indexOf(term) !== -1 ||
           creator.indexOf(term) !== -1;
  };

  c.filterByState = function(state) {
    if (state === 'all') {
      c.filters.state = '';
    } else {
      c.filters.state = state;
    }
    c.applyFilters();
  };

  c.resetFilters = function() {
    c.filters = {
      state: '',
      dateFrom: null,
      dateTo: null,
      creator: ''
    };
    c.searchTerm = '';
    c.data.currentPage = 1;
    c.refreshData();
  };

  // Sorting
  c.sortBy = function(field) {
    if (c.sortField === field) {
      c.sortReverse = !c.sortReverse;
    } else {
      c.sortField = field;
      c.sortReverse = false;
    }
  };

  c.handleSortKey = function($event, field) {
    if ($event.keyCode === 13 || $event.keyCode === 32) {
      $event.preventDefault();
      c.sortBy(field);
    }
  };

  c.getSortIcon = function(field) {
    if (c.sortField !== field) return 'fa-sort';
    return c.sortReverse ? 'fa-sort-desc' : 'fa-sort-asc';
  };

  c.getSortAria = function(field) {
    if (c.sortField !== field) return 'none';
    return c.sortReverse ? 'descending' : 'ascending';
  };

  // Row expansion / drill-down
  c.toggleRow = function(us) {
    if (c.expandedRows[us.sys_id]) {
      delete c.expandedRows[us.sys_id];
    } else {
      c.expandedRows[us.sys_id] = true;
      if (!us.xmlRecords) {
        c.loadDetails(us);
      }
    }
  };

  c.loadDetails = function(us) {
    c.loadingDetails[us.sys_id] = true;
    c.server.get({
      action: 'fetchDetails',
      updateSetId: us.sys_id
    }).then(function(response) {
      var data = response.data;
      us.xmlRecords = data.xmlRecords || [];
      us.typeSummary = data.typeSummary || {};
      us.migrationHistory = data.migrationHistory || [];
      us.conflicts = data.conflicts || [];
      us.hasConflicts = (us.conflicts && us.conflicts.length > 0);
      c.loadingDetails[us.sys_id] = false;
    }, function(error) {
      c.loadingDetails[us.sys_id] = false;
      us.xmlRecords = [];
      c.errorMessage = 'Failed to load details for ' + us.name;
    });
  };

  c.viewDetails = function(us) {
    if (!c.expandedRows[us.sys_id]) {
      c.toggleRow(us);
    }
  };

  // Quick actions
  c.markForMigration = function(us) {
    spModal.confirm('Mark "' + us.name + '" as Complete?').then(function(confirmed) {
      if (confirmed) {
        c.server.get({
          action: 'markComplete',
          updateSetId: us.sys_id
        }).then(function(response) {
          if (response.data.success) {
            us.state = 'complete';
            c.data.stats.in_progress = Math.max(0, (c.data.stats.in_progress || 1) - 1);
            c.data.stats.complete = (c.data.stats.complete || 0) + 1;
          } else {
            c.errorMessage = response.data.errorMessage || 'Failed to update status.';
          }
        }, function() {
          c.errorMessage = 'Server error while updating update set.';
        });
      }
    });
  };

  c.requestApproval = function(us) {
    spModal.confirm('Request deployment approval for "' + us.name + '"?').then(function(confirmed) {
      if (confirmed) {
        c.server.get({
          action: 'requestApproval',
          updateSetId: us.sys_id
        }).then(function(response) {
          if (response.data.success) {
            spModal.alert('Approval request submitted successfully for "' + us.name + '".');
          } else {
            c.errorMessage = response.data.errorMessage || 'Failed to submit approval request.';
          }
        }, function() {
          c.errorMessage = 'Server error while submitting approval request.';
        });
      }
    });
  };

  // Status class helper
  c.getStatusClass = function(state) {
    if (!state) return 'unknown';
    return state.replace(/\s+/g, '-').toLowerCase();
  };

  // Age calculation
  c.getAgeDays = function(createdOn) {
    if (!createdOn) return 0;
    var created = new Date(createdOn);
    var now = new Date();
    var diffMs = now - created;
    return Math.floor(diffMs / (1000 * 60 * 60 * 24));
  };

  c.getAgePriority = function(createdOn) {
    var days = c.getAgeDays(createdOn);
    if (days <= 7) return 'fresh';
    if (days <= 30) return 'recent';
    if (days <= 90) return 'aging';
    return 'old';
  };

  // Count helper for results info
  c.getFilteredCount = function() {
    return c.filteredSets ? c.filteredSets.length : 0;
  };

  // Keyboard action handler for stat cards
  c.handleKeyAction = function($event, state) {
    if ($event.keyCode === 13 || $event.keyCode === 32) {
      $event.preventDefault();
      c.filterByState(state);
    }
  };

  // Dismiss error
  c.dismissError = function() {
    c.errorMessage = '';
  };

  // Pagination
  c.goToPage = function(page) {
    if (page < 1 || page > c.data.totalPages) return;
    c.data.currentPage = page;
    c.refreshData();
  };

  // Export CSV
  c.exportCSV = function() {
    var rows = [
      ['Name', 'Status', 'Creator', 'Created', 'Modified', 'Updates', 'Description']
    ];
    var sets = c.data.updateSets || [];
    sets.forEach(function(us) {
      rows.push([
        '"' + (us.name || '').replace(/"/g, '""') + '"',
        us.state || '',
        us.sys_created_by || '',
        us.sys_created_on || '',
        us.sys_updated_on || '',
        us.update_count || 0,
        '"' + (us.description || '').replace(/"/g, '""') + '"'
      ]);
    });

    var csvContent = '';
    rows.forEach(function(row) {
      csvContent += row.join(',') + '\n';
    });

    var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    var link = document.createElement('a');
    if (link.download !== undefined) {
      var url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', 'update_set_migration_report_' + new Date().toISOString().slice(0, 10) + '.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    } else {
      c.errorMessage = 'CSV export is not supported in this browser.';
    }
  };
};]]></client_script>
<controller_as>c</controller_as>
<css>/* ========================================
   Update Set Migration Tracker - Widget CSS
   ======================================== */

.us-migration-tracker {
  --ust-color-primary: #007bfd;
  --ust-color-success: #28a745;
  --ust-color-warning: #ffc107;
  --ust-color-danger: #dc3545;
  --ust-color-info: #17a2b8;
  --ust-color-text: #212529;
  --ust-color-text-secondary: #6c757d;
  --ust-color-bg: #ffffff;
  --ust-color-bg-alt: #f8f9fa;
  --ust-color-bg-hover: #e9ecef;
  --ust-color-border: #dee2e6;
  --ust-color-border-light: #e9ecef;
  --ust-shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
  --ust-shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
  --ust-shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
  --ust-radius-sm: 4px;
  --ust-radius-md: 8px;
  --ust-radius-lg: 12px;
  --ust-transition-fast: 0.15s ease;
  --ust-transition-normal: 0.25s ease;
  --ust-font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  --ust-age-green: #28a745;
  --ust-age-yellow: #ffc107;
  --ust-age-orange: #fd7e14;
  --ust-age-red: #dc3545;

  font-family: var(--ust-font-family);
  color: var(--ust-color-text);
  padding: 20px;
  max-width: 1600px;
  margin: 0 auto;
}

/* ======= Statistics Bar ======= */
.ust-stats-bar {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 16px;
  margin-bottom: 24px;
}

.ust-stat-card {
  background: var(--ust-color-bg);
  border-radius: var(--ust-radius-md);
  padding: 20px;
  display: flex;
  align-items: center;
  gap: 16px;
  box-shadow: var(--ust-shadow-sm);
  border-left: 4px solid transparent;
  cursor: pointer;
  transition: transform var(--ust-transition-normal), box-shadow var(--ust-transition-normal);
  outline: none;
}

.ust-stat-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--ust-shadow-md);
}

.ust-stat-card:focus {
  outline: 2px solid var(--ust-color-primary);
  outline-offset: 2px;
}

.ust-stat-total { border-left-color: var(--ust-color-primary); }
.ust-stat-success { border-left-color: var(--ust-color-success); }
.ust-stat-pending { border-left-color: var(--ust-color-warning); }
.ust-stat-error { border-left-color: var(--ust-color-danger); }
.ust-stat-ignored { border-left-color: var(--ust-color-text-secondary); }

.ust-stat-icon {
  font-size: 28px;
  width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  flex-shrink: 0;
}

.ust-stat-total .ust-stat-icon { color: var(--ust-color-primary); background: rgba(0, 123, 253, 0.1); }
.ust-stat-success .ust-stat-icon { color: var(--ust-color-success); background: rgba(40, 167, 69, 0.1); }
.ust-stat-pending .ust-stat-icon { color: var(--ust-color-warning); background: rgba(255, 193, 7, 0.15); }
.ust-stat-error .ust-stat-icon { color: var(--ust-color-danger); background: rgba(220, 53, 69, 0.1); }
.ust-stat-ignored .ust-stat-icon { color: var(--ust-color-text-secondary); background: rgba(108, 117, 125, 0.1); }

.ust-stat-content {
  display: flex;
  flex-direction: column;
}

.ust-stat-number {
  font-size: 28px;
  font-weight: 700;
  line-height: 1.2;
}

.ust-stat-label {
  font-size: 12px;
  color: var(--ust-color-text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 500;
}

/* ======= Access Denied ======= */
.ust-access-denied {
  text-align: center;
  padding: 60px 20px;
  color: var(--ust-color-text-secondary);
}

.ust-access-denied h2 {
  margin: 16px 0 8px;
  color: var(--ust-color-danger);
}

/* ======= Toolbar ======= */
.ust-toolbar {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  align-items: flex-end;
  margin-bottom: 20px;
  padding: 20px;
  background: var(--ust-color-bg);
  border-radius: var(--ust-radius-md);
  box-shadow: var(--ust-shadow-sm);
}

.ust-search-group {
  flex: 1;
  min-width: 250px;
}

.ust-search-wrapper {
  position: relative;
  display: flex;
  align-items: center;
}

.ust-search-icon {
  position: absolute;
  left: 12px;
  color: var(--ust-color-text-secondary);
  pointer-events: none;
  z-index: 1;
}

.ust-search-input {
  width: 100%;
  padding: 10px 36px 10px 36px;
  border: 2px solid var(--ust-color-border);
  border-radius: var(--ust-radius-sm);
  font-size: 14px;
  transition: border-color var(--ust-transition-fast);
  background: var(--ust-color-bg);
}

.ust-search-input:focus {
  border-color: var(--ust-color-primary);
  outline: none;
  box-shadow: 0 0 0 3px rgba(0, 123, 253, 0.25);
}

.ust-search-clear {
  position: absolute;
  right: 8px;
  background: none;
  border: none;
  color: var(--ust-color-text-secondary);
  cursor: pointer;
  padding: 4px;
  font-size: 14px;
}

.ust-search-clear:hover {
  color: var(--ust-color-danger);
}

.ust-search-clear:focus {
  outline: 2px solid var(--ust-color-primary);
  outline-offset: 2px;
}

.ust-filter-group {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: flex-end;
}

.ust-filter-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.ust-filter-label {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--ust-color-text-secondary);
}

.ust-select,
.ust-date-input {
  padding: 8px 12px;
  border: 2px solid var(--ust-color-border);
  border-radius: var(--ust-radius-sm);
  font-size: 13px;
  background: var(--ust-color-bg);
  min-width: 140px;
  transition: border-color var(--ust-transition-fast);
}

.ust-select:focus,
.ust-date-input:focus {
  border-color: var(--ust-color-primary);
  outline: none;
  box-shadow: 0 0 0 3px rgba(0, 123, 253, 0.25);
}

.ust-action-group {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
}

.ust-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 9px 16px;
  border: 2px solid transparent;
  border-radius: var(--ust-radius-sm);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--ust-transition-fast);
  white-space: nowrap;
}

.ust-btn:focus {
  outline: 2px solid var(--ust-color-primary);
  outline-offset: 2px;
}

.ust-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.ust-btn-refresh {
  background: var(--ust-color-primary);
  color: #fff;
}

.ust-btn-refresh:hover:not(:disabled) {
  background: #0069d9;
}

.ust-btn-export {
  background: var(--ust-color-bg);
  color: var(--ust-color-text);
  border-color: var(--ust-color-border);
}

.ust-btn-export:hover:not(:disabled) {
  background: var(--ust-color-bg-hover);
  border-color: var(--ust-color-text-secondary);
}

.ust-btn-reset {
  background: var(--ust-color-bg);
  color: var(--ust-color-primary);
  border-color: var(--ust-color-primary);
}

.ust-btn-reset:hover {
  background: var(--ust-color-primary);
  color: #fff;
}

/* Auto-refresh toggle */
.ust-auto-refresh-toggle {
  display: flex;
  align-items: center;
}

.ust-toggle-label {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
  user-select: none;
}

.ust-toggle-label input[type="checkbox"] {
  position: absolute;
  opacity: 0;
  width: 0;
  height: 0;
}

.ust-toggle-slider {
  width: 40px;
  height: 22px;
  background: var(--ust-color-border);
  border-radius: 11px;
  position: relative;
  transition: background var(--ust-transition-fast);
  flex-shrink: 0;
}

.ust-toggle-slider::after {
  content: '';
  position: absolute;
  width: 18px;
  height: 18px;
  background: #fff;
  border-radius: 50%;
  top: 2px;
  left: 2px;
  transition: transform var(--ust-transition-fast);
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.ust-toggle-label input:checked + .ust-toggle-slider {
  background: var(--ust-color-success);
}

.ust-toggle-label input:checked + .ust-toggle-slider::after {
  transform: translateX(18px);
}

.ust-toggle-label input:focus + .ust-toggle-slider {
  outline: 2px solid var(--ust-color-primary);
  outline-offset: 2px;
}

/* ======= Loading ======= */
.ust-loading-overlay {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  padding: 40px;
  color: var(--ust-color-text-secondary);
  font-size: 14px;
}

.ust-spinner {
  width: 32px;
  height: 32px;
  border: 3px solid var(--ust-color-border);
  border-top-color: var(--ust-color-primary);
  border-radius: 50%;
  animation: ust-spin 0.8s linear infinite;
}

.ust-spinner-sm {
  width: 20px;
  height: 20px;
  border: 2px solid var(--ust-color-border);
  border-top-color: var(--ust-color-primary);
  border-radius: 50%;
  animation: ust-spin 0.8s linear infinite;
  display: inline-block;
}

@keyframes ust-spin {
  to { transform: rotate(360deg); }
}

@media (prefers-reduced-motion: reduce) {
  .ust-spinner,
  .ust-spinner-sm {
    animation: none;
    border-top-color: var(--ust-color-primary);
    opacity: 0.7;
  }
  .ust-stat-card,
  .ust-btn,
  .ust-select,
  .ust-date-input,
  .ust-search-input,
  .ust-toggle-slider,
  .ust-toggle-slider::after,
  .ust-env-connector,
  .ust-env-dot {
    transition: none !important;
  }
  .ust-pulse {
    animation: none !important;
  }
}

/* ======= Error Banner ======= */
.ust-error-banner {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
  border-radius: var(--ust-radius-sm);
  margin-bottom: 16px;
}

.ust-error-dismiss {
  margin-left: auto;
  background: none;
  border: none;
  color: #721c24;
  cursor: pointer;
  padding: 4px;
  font-size: 16px;
}

.ust-error-dismiss:focus {
  outline: 2px solid var(--ust-color-primary);
  outline-offset: 2px;
}

/* ======= Results Info ======= */
.ust-results-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  font-size: 13px;
  color: var(--ust-color-text-secondary);
  padding: 0 4px;
}

.ust-avg-time {
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

/* ======= Data Table ======= */
.ust-table-container {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  border-radius: var(--ust-radius-md);
  box-shadow: var(--ust-shadow-sm);
  background: var(--ust-color-bg);
}

.ust-table {
  width: 100%;
  border-collapse: collapse;
  min-width: 1000px;
}

.ust-table thead {
  position: sticky;
  top: 0;
  z-index: 10;
  background: var(--ust-color-bg-alt);
}

.ust-table thead th {
  padding: 14px 12px;
  text-align: left;
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--ust-color-text-secondary);
  border-bottom: 2px solid var(--ust-color-border);
  white-space: nowrap;
  user-select: none;
}

.ust-th-sortable {
  cursor: pointer;
  transition: color var(--ust-transition-fast);
}

.ust-th-sortable:hover {
  color: var(--ust-color-primary);
}

.ust-th-sortable:focus {
  outline: 2px solid var(--ust-color-primary);
  outline-offset: -2px;
}

.ust-th-sortable i {
  margin-left: 4px;
  font-size: 10px;
}

.ust-table tbody tr {
  border-bottom: 1px solid var(--ust-color-border-light);
  transition: background var(--ust-transition-fast);
}

.ust-table tbody tr:nth-child(4n+1) {
  background: var(--ust-color-bg-alt);
}

.ust-table tbody tr.ust-row:hover {
  background: var(--ust-color-bg-hover);
}

.ust-row-conflict {
  border-left: 3px solid var(--ust-color-danger) !important;
}

.ust-row-expanded {
  background: rgba(0, 123, 253, 0.04) !important;
}

.ust-table td {
  padding: 12px;
  font-size: 13px;
  vertical-align: middle;
}

.ust-td-expand {
  width: 40px;
  text-align: center;
}

.ust-expand-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 6px;
  color: var(--ust-color-text-secondary);
  border-radius: var(--ust-radius-sm);
  transition: all var(--ust-transition-fast);
}

.ust-expand-btn:hover {
  color: var(--ust-color-primary);
  background: rgba(0, 123, 253, 0.1);
}

.ust-expand-btn:focus {
  outline: 2px solid var(--ust-color-primary);
  outline-offset: 2px;
}

.ust-td-name {
  max-width: 250px;
}

.ust-name-text {
  font-weight: 600;
  color: var(--ust-color-text);
  display: inline-block;
  max-width: 220px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  vertical-align: middle;
}

.ust-conflict-icon {
  color: var(--ust-color-danger);
  margin-left: 6px;
  font-size: 12px;
  vertical-align: middle;
}

/* Status badges */
.ust-status-badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
}

.ust-status-complete {
  background: rgba(40, 167, 69, 0.12);
  color: #1e7e34;
}

.ust-status-in-progress {
  background: rgba(255, 193, 7, 0.15);
  color: #856404;
}

.ust-status-backed-out {
  background: rgba(220, 53, 69, 0.12);
  color: #bd2130;
}

.ust-status-ignore {
  background: rgba(108, 117, 125, 0.12);
  color: #495057;
}

.ust-status-committed {
  background: rgba(0, 123, 253, 0.12);
  color: #0056b3;
}

/* Environment Progress */
.ust-td-env {
  min-width: 200px;
}

.ust-env-progress {
  display: flex;
  align-items: center;
  gap: 0;
}

.ust-env-step {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

.ust-env-dot {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  border: 3px solid var(--ust-color-border);
  transition: all var(--ust-transition-normal);
  position: relative;
}

.ust-env-dot-filled.ust-env-dot-dev {
  background: var(--ust-color-primary);
  border-color: var(--ust-color-primary);
}

.ust-env-dot-filled.ust-env-dot-test {
  background: var(--ust-color-warning);
  border-color: var(--ust-color-warning);
}

.ust-env-dot-filled.ust-env-dot-prod {
  background: var(--ust-color-success);
  border-color: var(--ust-color-success);
}

.ust-env-connector {
  width: 30px;
  height: 3px;
  background: var(--ust-color-border);
  transition: background var(--ust-transition-normal);
}

.ust-env-connector-active {
  background: var(--ust-color-success);
}

.ust-env-label {
  font-size: 9px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--ust-color-text-secondary);
}

.ust-env-active .ust-env-label {
  color: var(--ust-color-text);
}

/* Count badge */
.ust-count-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 28px;
  height: 28px;
  padding: 0 8px;
  background: var(--ust-color-bg-alt);
  border-radius: 14px;
  font-size: 12px;
  font-weight: 700;
  color: var(--ust-color-text);
}

/* Age badge */
.ust-age-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 36px;
  height: 24px;
  padding: 0 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 700;
  color: #fff;
}

.ust-age-fresh { background: var(--ust-age-green); }
.ust-age-recent { background: var(--ust-age-yellow); color: #212529; }
.ust-age-aging { background: var(--ust-age-orange); }
.ust-age-old { background: var(--ust-age-red); }

/* Actions */
.ust-td-actions {
  white-space: nowrap;
}

.ust-actions-menu {
  display: flex;
  gap: 4px;
}

.ust-action-btn {
  width: 32px;
  height: 32px;
  border: none;
  border-radius: var(--ust-radius-sm);
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
  transition: all var(--ust-transition-fast);
}

.ust-action-btn:focus {
  outline: 2px solid var(--ust-color-primary);
  outline-offset: 2px;
}

.ust-action-mark {
  background: rgba(40, 167, 69, 0.1);
  color: var(--ust-color-success);
}

.ust-action-mark:hover {
  background: var(--ust-color-success);
  color: #fff;
}

.ust-action-approve {
  background: rgba(0, 123, 253, 0.1);
  color: var(--ust-color-primary);
}

.ust-action-approve:hover {
  background: var(--ust-color-primary);
  color: #fff;
}

.ust-action-view {
  background: rgba(108, 117, 125, 0.1);
  color: var(--ust-color-text-secondary);
}

.ust-action-view:hover {
  background: var(--ust-color-text-secondary);
  color: #fff;
}

/* ======= Detail Panel ======= */
.ust-detail-row td {
  padding: 0 !important;
  background: var(--ust-color-bg) !important;
}

.ust-detail-panel {
  padding: 20px 24px;
  border-top: 2px solid var(--ust-color-primary);
  animation: ust-slideDown 0.25s ease-out;
}

@keyframes ust-slideDown {
  from {
    opacity: 0;
    max-height: 0;
    transform: translateY(-8px);
  }
  to {
    opacity: 1;
    max-height: 2000px;
    transform: translateY(0);
  }
}

@media (prefers-reduced-motion: reduce) {
  .ust-detail-panel {
    animation: none;
  }
}

.ust-detail-loading {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 20px;
  color: var(--ust-color-text-secondary);
  font-size: 13px;
}

.ust-detail-section {
  margin-bottom: 20px;
}

.ust-detail-section:last-child {
  margin-bottom: 0;
}

.ust-detail-heading {
  font-size: 14px;
  font-weight: 700;
  margin: 0 0 10px 0;
  padding-bottom: 6px;
  border-bottom: 1px solid var(--ust-color-border-light);
  color: var(--ust-color-text);
}

.ust-heading-warning {
  color: var(--ust-color-danger);
}

.ust-detail-desc {
  font-size: 13px;
  color: var(--ust-color-text-secondary);
  line-height: 1.5;
  margin: 0;
}

/* XML Records Grid */
.ust-xml-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 10px;
  max-height: 300px;
  overflow-y: auto;
}

.ust-xml-card {
  padding: 10px 12px;
  background: var(--ust-color-bg-alt);
  border-radius: var(--ust-radius-sm);
  border-left: 3px solid var(--ust-color-info);
}

.ust-xml-type-badge {
  display: inline-block;
  padding: 2px 8px;
  background: rgba(23, 162, 184, 0.12);
  color: #117a8b;
  border-radius: 10px;
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
}

.ust-xml-info {
  margin-top: 6px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 8px;
}

.ust-xml-name {
  font-size: 12px;
  font-weight: 600;
  color: var(--ust-color-text);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  flex: 1;
}

.ust-xml-action {
  padding: 2px 6px;
  border-radius: 8px;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
}

.ust-xml-action-INSERT { background: rgba(40, 167, 69, 0.12); color: #1e7e34; }
.ust-xml-action-UPDATE { background: rgba(0, 123, 253, 0.12); color: #0056b3; }
.ust-xml-action-DELETE { background: rgba(220, 53, 69, 0.12); color: #bd2130; }

.ust-xml-meta {
  margin-top: 4px;
  font-size: 11px;
  color: var(--ust-color-text-secondary);
}

.ust-no-data {
  color: var(--ust-color-text-secondary);
  font-size: 13px;
  font-style: italic;
  margin: 0;
}

/* Type chips */
.ust-type-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.ust-type-chip {
  display: inline-block;
  padding: 4px 12px;
  background: var(--ust-color-bg-alt);
  border: 1px solid var(--ust-color-border);
  border-radius: 16px;
  font-size: 12px;
  color: var(--ust-color-text-secondary);
}

/* Timeline */
.ust-timeline {
  position: relative;
  padding-left: 24px;
}

.ust-timeline::before {
  content: '';
  position: absolute;
  left: 8px;
  top: 0;
  bottom: 0;
  width: 2px;
  background: var(--ust-color-border);
}

.ust-timeline-item {
  position: relative;
  padding-bottom: 16px;
  padding-left: 16px;
}

.ust-timeline-item:last-child {
  padding-bottom: 0;
}

.ust-timeline-dot {
  position: absolute;
  left: -20px;
  top: 4px;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: var(--ust-color-border);
  border: 2px solid var(--ust-color-bg);
  z-index: 1;
}

.ust-timeline-dot-committed { background: var(--ust-color-success); }
.ust-timeline-dot-previewed { background: var(--ust-color-info); }
.ust-timeline-dot-loaded { background: var(--ust-color-warning); }
.ust-timeline-dot-error { background: var(--ust-color-danger); }

.ust-timeline-content {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
}

.ust-timeline-date {
  font-size: 12px;
  font-weight: 600;
  color: var(--ust-color-text);
}

.ust-timeline-desc {
  font-size: 12px;
  color: var(--ust-color-text-secondary);
}

/* Conflicts */
.ust-conflict-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.ust-conflict-item {
  display: flex;
  gap: 10px;
  padding: 10px 14px;
  background: #fff5f5;
  border: 1px solid #f5c6cb;
  border-radius: var(--ust-radius-sm);
  color: var(--ust-color-danger);
  align-items: flex-start;
}

.ust-conflict-info {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.ust-conflict-desc {
  font-size: 13px;
  font-weight: 500;
  color: #721c24;
}

.ust-conflict-type {
  font-size: 11px;
  color: var(--ust-color-text-secondary);
}

/* ======= Empty State ======= */
.ust-empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--ust-color-text-secondary);
}

.ust-empty-state h3 {
  margin: 16px 0 8px;
  color: var(--ust-color-text);
}

.ust-empty-state p {
  margin-bottom: 20px;
}

/* ======= Pagination ======= */
.ust-pagination {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  margin-top: 20px;
  padding: 16px;
}

.ust-page-btn {
  width: 36px;
  height: 36px;
  border: 2px solid var(--ust-color-border);
  border-radius: var(--ust-radius-sm);
  background: var(--ust-color-bg);
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  color: var(--ust-color-text);
  transition: all var(--ust-transition-fast);
}

.ust-page-btn:hover:not(:disabled) {
  border-color: var(--ust-color-primary);
  color: var(--ust-color-primary);
  background: rgba(0, 123, 253, 0.05);
}

.ust-page-btn:focus {
  outline: 2px solid var(--ust-color-primary);
  outline-offset: 2px;
}

.ust-page-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.ust-page-info {
  font-size: 13px;
  font-weight: 600;
  color: var(--ust-color-text-secondary);
  padding: 0 12px;
}

/* ======= Footer ======= */
.ust-footer-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 12px;
  font-size: 12px;
  color: var(--ust-color-text-secondary);
  padding: 0 4px;
}

.ust-auto-indicator {
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.ust-pulse {
  color: var(--ust-color-success);
  font-size: 8px;
  animation: ust-pulse 2s ease-in-out infinite;
}

@keyframes ust-pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

/* ======= Screen reader only ======= */
.us-migration-tracker .sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

/* ======= Responsive - Tablet ======= */
@media screen and (max-width: 1024px) {
  .ust-stats-bar {
    grid-template-columns: repeat(3, 1fr);
  }

  .ust-toolbar {
    flex-direction: column;
    align-items: stretch;
  }

  .ust-search-group {
    min-width: 100%;
  }

  .ust-filter-group {
    justify-content: flex-start;
  }

  .ust-action-group {
    justify-content: flex-start;
  }

  .ust-xml-grid {
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  }
}

/* ======= Responsive - Mobile ======= */
@media screen and (max-width: 768px) {
  .us-migration-tracker {
    padding: 12px;
  }

  .ust-stats-bar {
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
  }

  .ust-stat-card {
    padding: 14px;
    gap: 10px;
  }

  .ust-stat-icon {
    font-size: 22px;
    width: 38px;
    height: 38px;
  }

  .ust-stat-number {
    font-size: 22px;
  }

  .ust-toolbar {
    padding: 14px;
    gap: 12px;
  }

  .ust-filter-group {
    flex-direction: column;
  }

  .ust-filter-item {
    width: 100%;
  }

  .ust-select,
  .ust-date-input {
    width: 100%;
    min-width: unset;
  }

  .ust-action-group {
    flex-wrap: wrap;
  }

  .ust-btn-text {
    display: none;
  }

  .ust-table-container {
    margin: 0 -12px;
    border-radius: 0;
  }

  .ust-results-info {
    flex-direction: column;
    gap: 4px;
    align-items: flex-start;
  }

  .ust-pagination {
    padding: 12px;
  }

  .ust-footer-info {
    flex-direction: column;
    gap: 4px;
    align-items: flex-start;
  }

  .ust-xml-grid {
    grid-template-columns: 1fr;
  }

  .ust-detail-panel {
    padding: 14px;
  }

  .ust-timeline-content {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
  }
}

/* ======= Responsive - Small mobile ======= */
@media screen and (max-width: 480px) {
  .ust-stats-bar {
    grid-template-columns: 1fr;
  }

  .ust-stat-card {
    padding: 12px;
  }
}

/* ======= High contrast mode support ======= */
@media (forced-colors: active) {
  .ust-stat-card,
  .ust-table thead th,
  .ust-status-badge,
  .ust-age-badge,
  .ust-env-dot {
    forced-color-adjust: none;
  }
}</css>
<data_table>sp_instance</data_table>
<demo_data/>
<description>SERVICENOW SERVICE PORTAL WIDGET REQUIREMENTS SPECIFICATION

Widget Name: Update Set Migration Tracker

Purpose: 
Provide system administrators with a comprehensive real-time dashboard to monitor and </description>
<docs display_value=""/>
<field_list/>
<has_preview>false</has_preview>
<id>update_set_migration_tracker_235c8ec1</id>
<internal>false</internal>
<link><![CDATA[function link(scope, element, attrs, controller) {  }]]></link>
<name>Update Set Migration Tracker</name>
<option_schema/>
<public>true</public>
<roles/>
<script><![CDATA[(function() {
  // Determine which action to perform
  var action = input ? input.action : '';

  // ===== Access Control Validation =====
  function hasRequiredRole() {
    var userID = gs.getUserID();
    if (gs.hasRole('admin') || gs.hasRole('maint') || gs.hasRole('update_set_installer')) {
      return true;
    }
    // Check for custom deployment role
    var grRole = new GlideRecord('sys_user_has_role');
    grRole.addQuery('user', userID);
    grRole.addQuery('role.name', 'IN', 'admin,maint,update_set_installer');
    grRole.addQuery('state', 'active');
    grRole.setLimit(1);
    grRole.query();
    return grRole.hasNext();
  }

  if (!hasRequiredRole()) {
    data.accessDenied = true;
    return;
  }
  data.accessDenied = false;

  // ===== Fetch Update Sets =====
  if (!action || action === 'fetchUpdateSets') {
    var stateFilter = input ? (input.state || '') : '';
    var dateFrom = input ? (input.dateFrom || '') : '';
    var dateTo = input ? (input.dateTo || '') : '';
    var creatorFilter = input ? (input.creator || '') : '';
    var page = input ? (parseInt(input.page, 10) || 1) : 1;
    var pageSize = input ? (parseInt(input.pageSize, 10) || 50) : 50;

    // --- Statistics using GlideAggregate ---
    data.stats = {
      total: 0,
      complete: 0,
      in_progress: 0,
      backed_out: 0,
      ignore: 0
    };

    var gaStats = new GlideAggregate('sys_update_set');
    gaStats.addQuery('is_default', false);
    gaStats.addAggregate('COUNT', 'state');
    gaStats.groupBy('state');
    gaStats.query();
    while (gaStats.next()) {
      var stateVal = gaStats.getValue('state');
      var countVal = parseInt(gaStats.getAggregate('COUNT', 'state'), 10) || 0;
      data.stats.total += countVal;
      if (stateVal === 'complete') data.stats.complete = countVal;
      else if (stateVal === 'in progress') data.stats.in_progress = countVal;
      else if (stateVal === 'backed out') data.stats.backed_out = countVal;
      else if (stateVal === 'ignore') data.stats.ignore = countVal;
    }

    // --- Get distinct creators ---
    data.creators = [];
    var gaCreators = new GlideAggregate('sys_update_set');
    gaCreators.addQuery('is_default', false);
    gaCreators.addAggregate('COUNT');
    gaCreators.groupBy('sys_created_by');
    gaCreators.orderBy('sys_created_by');
    gaCreators.query();
    while (gaCreators.next()) {
      var creatorName = gaCreators.getValue('sys_created_by');
      if (creatorName) {
        data.creators.push(creatorName);
      }
    }

    // --- Calculate average migration time ---
    data.avgMigrationTime = '';
    var gaAvg = new GlideAggregate('sys_remote_update_set');
    gaAvg.addQuery('state', 'committed');
    gaAvg.addNotNullQuery('commit_date');
    gaAvg.addAggregate('COUNT');
    gaAvg.query();
    var totalMigrationHours = 0;
    var migrationCount = 0;

    var grMig = new GlideRecord('sys_remote_update_set');
    grMig.addQuery('state', 'committed');
    grMig.addNotNullQuery('commit_date');
    grMig.orderByDesc('commit_date');
    grMig.setLimit(200);
    grMig.query();
    while (grMig.next()) {
      var commitDate = new GlideDateTime(grMig.getValue('commit_date'));
      var createdDate = new GlideDateTime(grMig.getValue('sys_created_on'));
      if (commitDate && createdDate) {
        var diffMs = GlideDateTime.subtract(createdDate, commitDate);
        var hours = diffMs.getNumericValue() / (1000 * 60 * 60);
        if (hours >= 0 && hours < 8760) { // Sanity check: less than a year
          totalMigrationHours += hours;
          migrationCount++;
        }
      }
    }
    if (migrationCount > 0) {
      var avgHours = Math.round(totalMigrationHours / migrationCount * 10) / 10;
      if (avgHours < 1) {
        data.avgMigrationTime = Math.round(avgHours * 60) + ' minutes';
      } else if (avgHours < 24) {
        data.avgMigrationTime = avgHours + ' hours';
      } else {
        data.avgMigrationTime = Math.round(avgHours / 24 * 10) / 10 + ' days';
      }
    }

    // --- Count total for pagination ---
    var gaTotal = new GlideAggregate('sys_update_set');
    gaTotal.addQuery('is_default', false);
    if (stateFilter) gaTotal.addQuery('state', stateFilter);
    if (creatorFilter) gaTotal.addQuery('sys_created_by', creatorFilter);
    if (dateFrom) gaTotal.addQuery('sys_created_on', '>=', dateFrom);
    if (dateTo) gaTotal.addQuery('sys_created_on', '<=', dateTo + ' 23:59:59');
    gaTotal.addAggregate('COUNT');
    gaTotal.query();
    var totalRecords = 0;
    if (gaTotal.next()) {
      totalRecords = parseInt(gaTotal.getAggregate('COUNT'), 10) || 0;
    }
    data.totalPages = Math.max(1, Math.ceil(totalRecords / pageSize));
    data.currentPage = Math.min(page, data.totalPages);

    // --- Fetch update sets with pagination ---
    data.updateSets = [];
    var offset = (data.currentPage - 1) * pageSize;

    var grUS = new GlideRecord('sys_update_set');
    grUS.addQuery('is_default', false);
    if (stateFilter) grUS.addQuery('state', stateFilter);
    if (creatorFilter) grUS.addQuery('sys_created_by', creatorFilter);
    if (dateFrom) grUS.addQuery('sys_created_on', '>=', dateFrom);
    if (dateTo) grUS.addQuery('sys_created_on', '<=', dateTo + ' 23:59:59');
    grUS.orderByDesc('sys_updated_on');
    grUS.chooseWindow(offset, offset + pageSize);
    grUS.query();

    // Collect sys_ids for batch XML count lookup
    var usIds = [];
    var usRecords = [];

    while (grUS.next()) {
      var usObj = {
        sys_id: grUS.getUniqueValue(),
        name: grUS.getValue('name') || '',
        description: grUS.getValue('description') || '',
        state: grUS.getValue('state') || '',
        application: grUS.getDisplayValue('application') || '',
        base_update_set: grUS.getValue('base_update_set') || '',
        release_date: grUS.getValue('release_date') || '',
        install_date: grUS.getValue('install_date') || '',
        installed_from: grUS.getValue('installed_from') || '',
        remote_sys_id: grUS.getValue('remote_sys_id') || '',
        origin_sys_id: grUS.getValue('origin_sys_id') || '',
        sys_created_by: grUS.getValue('sys_created_by') || '',
        sys_created_on: grUS.getDisplayValue('sys_created_on') || '',
        sys_updated_by: grUS.getValue('sys_updated_by') || '',
        sys_updated_on: grUS.getDisplayValue('sys_updated_on') || '',
        update_count: 0,
        hasConflicts: false,
        envStatus: { dev: true, test: false, prod: false }
      };
      usIds.push(usObj.sys_id);
      usRecords.push(usObj);
    }

    // --- Batch count update XMLs per update set ---
    if (usIds.length > 0) {
      var xmlCounts = {};
      var gaXml = new GlideAggregate('sys_update_xml');
      gaXml.addQuery('update_set', 'IN', usIds.join(','));
      gaXml.addAggregate('COUNT', 'update_set');
      gaXml.groupBy('update_set');
      gaXml.query();
      while (gaXml.next()) {
        var xmlUsId = gaXml.getValue('update_set');
        xmlCounts[xmlUsId] = parseInt(gaXml.getAggregate('COUNT', 'update_set'), 10) || 0;
      }

      // --- Check remote update set status for environment progress ---
      var remoteStatus = {};
      var grRemote = new GlideRecord('sys_remote_update_set');
      grRemote.addQuery('remote_sys_id', 'IN', usIds.join(','));
      grRemote.query();
      while (grRemote.next()) {
        var remId = grRemote.getValue('remote_sys_id');
        var remState = grRemote.getValue('state') || '';
        if (!remoteStatus[remId]) {
          remoteStatus[remId] = [];
        }
        remoteStatus[remId].push(remState);
      }

      // --- Check for conflicts ---
      var conflictSets = {};
      var grConflict = new GlideRecord('sys_update_preview_problem');
      grConflict.addQuery('remote_update.update_set.sys_id', 'IN', usIds.join(','));
      grConflict.addQuery('type', '!=', '');
      grConflict.setLimit(500);
      grConflict.query();
      while (grConflict.next()) {
        // Try to map back to update set
        var conflictRemote = grConflict.getDisplayValue('remote_update');
        // We'll mark any with problems
        var ruGr = grConflict.getElement('remote_update');
        if (ruGr) {
          var ruRef = grConflict.getValue('remote_update');
          if (ruRef) {
            // Look up the remote update to get update_set
            var grRU = new GlideRecord('sys_update_xml');
            grRU.setLimit(1);
            if (grRU.get(ruRef)) {
              var conflictUsId = grRU.getValue('update_set');
              if (conflictUsId) {
                conflictSets[conflictUsId] = true;
              }
            }
          }
        }
      }

      // Apply batch data to records
      for (var i = 0; i < usRecords.length; i++) {
        var rec = usRecords[i];
        rec.update_count = xmlCounts[rec.sys_id] || 0;
        rec.hasConflicts = conflictSets[rec.sys_id] || false;

        // Determine environment status
        rec.envStatus.dev = true; // Always in dev if it exists
        if (remoteStatus[rec.sys_id]) {
          var states = remoteStatus[rec.sys_id];
          // If it has remote records, it's been pushed to at least test
          rec.envStatus.test = true;
          for (var s = 0; s < states.length; s++) {
            if (states[s] === 'committed') {
              rec.envStatus.prod = true;
            }
          }
        }
        // If state is complete and installed_from is populated, likely in prod
        if (rec.state === 'complete' && rec.installed_from) {
          rec.envStatus.test = true;
        }
      }
    }

    data.updateSets = usRecords;
  }

  // ===== Fetch Details for a specific Update Set =====
  if (action === 'fetchDetails') {
    var updateSetId = input.updateSetId || '';
    data.xmlRecords = [];
    data.typeSummary = {};
    data.migrationHistory = [];
    data.conflicts = [];

    if (updateSetId) {
      // Fetch XML records
      var grXml = new GlideRecord('sys_update_xml');
      grXml.addQuery('update_set', updateSetId);
      grXml.orderByDesc('sys_created_on');
      grXml.setLimit(100);
      grXml.query();
      while (grXml.next()) {
        var xmlObj = {
          sys_id: grXml.getUniqueValue(),
          name: grXml.getValue('name') || '',
          type: grXml.getValue('type') || 'unknown',
          target_name: grXml.getValue('target_name') || grXml.getValue('name') || '',
          action: grXml.getValue('action') || '',
          category: grXml.getValue('category') || '',
          sys_created_by: grXml.getValue('sys_created_by') || '',
          sys_created_on: grXml.getDisplayValue('sys_created_on') || ''
        };
        data.xmlRecords.push(xmlObj);

        // Build type summary
        var xmlType = xmlObj.type || 'other';
        if (!data.typeSummary[xmlType]) {
          data.typeSummary[xmlType] = 0;
        }
        data.typeSummary[xmlType]++;
      }

      // Fetch migration history from sys_remote_update_set
      var grRemHist = new GlideRecord('sys_remote_update_set');
      grRemHist.addQuery('remote_sys_id', updateSetId);
      grRemHist.orderBy('sys_created_on');
      grRemHist.query();
      while (grRemHist.next()) {
        var histObj = {
          date: grRemHist.getDisplayValue('sys_created_on') || '',
          description: 'Remote update set ' + (grRemHist.getValue('state') || '') +
                       (grRemHist.getValue('commit_date') ? ' (committed: ' + grRemHist.getDisplayValue('commit_date') + ')' : ''),
          status: grRemHist.getValue('state') || 'loaded'
        };
        data.migrationHistory.push(histObj);
      }

      // Also check by the update set's own sys_id in remote base
      var grRemHist2 = new GlideRecord('sys_remote_update_set');
      grRemHist2.addQuery('remote_base_update_set', updateSetId);
      grRemHist2.orderBy('sys_created_on');
      grRemHist2.query();
      while (grRemHist2.next()) {
        var histObj2 = {
          date: grRemHist2.getDisplayValue('sys_created_on') || '',
          description: 'Batch migration: ' + (grRemHist2.getValue('state') || '') +
                       ' via ' + (grRemHist2.getDisplayValue('update_set') || ''),
          status: grRemHist2.getValue('state') || 'loaded'
        };
        data.migrationHistory.push(histObj2);
      }

      // Add creation event to timeline
      var grOriginal = new GlideRecord('sys_update_set');
      if (grOriginal.get(updateSetId)) {
        data.migrationHistory.unshift({
          date: grOriginal.getDisplayValue('sys_created_on'),
          description: 'Update set created by ' + grOriginal.getValue('sys_created_by'),
          status: 'loaded'
        });
      }

      // Fetch conflicts/preview problems
      var grProb = new GlideRecord('sys_update_preview_problem');
      grProb.addQuery('remote_update.update_set', updateSetId);
      grProb.setLimit(50);
      grProb.query();
      while (grProb.next()) {
        data.conflicts.push({
          description: grProb.getValue('description') || grProb.getDisplayValue('description') || 'Unknown conflict',
          type: grProb.getValue('type') || 'Unknown',
          status: grProb.getValue('status') || 'Open'
        });
      }

      // Alternative: check by remote_sys_id
      if (data.conflicts.length === 0) {
        var grRemIds = new GlideRecord('sys_remote_update_set');
        grRemIds.addQuery('remote_sys_id', updateSetId);
        grRemIds.query();
        while (grRemIds.next()) {
          var remSysId = grRemIds.getUniqueValue();
          var grProb2 = new GlideRecord('sys_update_preview_problem');
          grProb2.addQuery('remote_update.remote_update_set', remSysId);
          grProb2.setLimit(50);
          grProb2.query();
          while (grProb2.next()) {
            data.conflicts.push({
              description: grProb2.getValue('description') || grProb2.getDisplayValue('description') || 'Conflict detected',
              type: grProb2.getValue('type') || 'Unknown',
              status: grProb2.getValue('status') || 'Open'
            });
          }
        }
      }
    }
  }

  // ===== Mark Update Set as Complete =====
  if (action === 'markComplete') {
    data.success = false;
    data.errorMessage = '';
    var markId = input.updateSetId || '';
    if (markId) {
      var grMark = new GlideRecord('sys_update_set');
      if (grMark.get(markId)) {
        grMark.setValue('state', 'complete');
        grMark.update();
        data.success = true;
      } else {
        data.errorMessage = 'Update set not found.';
      }
    } else {
      data.errorMessage = 'No update set ID provided.';
    }
  }

  // ===== Request Approval =====
  if (action === 'requestApproval') {
    data.success = false;
    data.errorMessage = '';
    var approvalUsId = input.updateSetId || '';
    if (approvalUsId) {
      // Create an event or notification for approval
      // In practice, this might create a request or trigger a workflow
      var grApprovalUS = new GlideRecord('sys_update_set');
      if (grApprovalUS.get(approvalUsId)) {
        try {
          // Log the approval request via system event
          gs.eventQueue('update_set.approval.requested', grApprovalUS, gs.getUserID(), grApprovalUS.getValue('name'));
          data.success = true;
        } catch (e) {
          // If event doesn't exist, just log it
          gs.info('Update Set approval requested for: ' + grApprovalUS.getValue('name') + ' by ' + gs.getUserDisplayName());
          data.success = true;
        }
      } else {
        data.errorMessage = 'Update set not found.';
      }
    } else {
      data.errorMessage = 'No update set ID provided.';
    }
  }
})();]]></script>
<servicenow>false</servicenow>
<sys_class_name>sp_widget</sys_class_name>
<sys_created_by>admin</sys_created_by>
<sys_created_on>2026-02-11 02:02:21</sys_created_on>
<sys_id>dcf36fe8938bbe5013b7326efaba10bf</sys_id>
<sys_mod_count>7</sys_mod_count>
<sys_name>Update Set Migration Tracker</sys_name>
<sys_package display_value="Global" source="global">global</sys_package>
<sys_policy/>
<sys_scope display_value="Global">global</sys_scope>
<sys_update_name>sp_widget_dcf36fe8938bbe5013b7326efaba10bf</sys_update_name>
<sys_updated_by>admin</sys_updated_by>
<sys_updated_on>2026-02-11 03:51:18</sys_updated_on>
<template><![CDATA[<div class="us-migration-tracker" role="main" aria-label="Update Set Migration Tracker">
  <!-- Statistics Dashboard -->
  <div class="ust-stats-bar" aria-label="Migration Statistics Summary" role="region">
    <div class="ust-stat-card ust-stat-total" tabindex="0" role="button"
         ng-click="c.filterByState('all')" ng-keydown="c.handleKeyAction($event, 'all')"
         aria-label="Total update sets: {{c.data.stats.total}}">
      <div class="ust-stat-icon">
        <i class="fa fa-database" aria-hidden="true"></i>
      </div>
      <div class="ust-stat-content">
        <span class="ust-stat-number">{{c.data.stats.total || 0}}</span>
        <span class="ust-stat-label">Total Update Sets</span>
      </div>
    </div>
    <div class="ust-stat-card ust-stat-success" tabindex="0" role="button"
         ng-click="c.filterByState('complete')" ng-keydown="c.handleKeyAction($event, 'complete')"
         aria-label="Successful migrations: {{c.data.stats.complete}}">
      <div class="ust-stat-icon">
        <i class="fa fa-check-circle" aria-hidden="true"></i>
      </div>
      <div class="ust-stat-content">
        <span class="ust-stat-number">{{c.data.stats.complete || 0}}</span>
        <span class="ust-stat-label">Completed</span>
      </div>
    </div>
    <div class="ust-stat-card ust-stat-pending" tabindex="0" role="button"
         ng-click="c.filterByState('in progress')" ng-keydown="c.handleKeyAction($event, 'in progress')"
         aria-label="In progress: {{c.data.stats.in_progress}}">
      <div class="ust-stat-icon">
        <i class="fa fa-clock-o" aria-hidden="true"></i>
      </div>
      <div class="ust-stat-content">
        <span class="ust-stat-number">{{c.data.stats.in_progress || 0}}</span>
        <span class="ust-stat-label">In Progress</span>
      </div>
    </div>
    <div class="ust-stat-card ust-stat-error" tabindex="0" role="button"
         ng-click="c.filterByState('backed out')" ng-keydown="c.handleKeyAction($event, 'backed out')"
         aria-label="Backed out: {{c.data.stats.backed_out}}">
      <div class="ust-stat-icon">
        <i class="fa fa-exclamation-triangle" aria-hidden="true"></i>
      </div>
      <div class="ust-stat-content">
        <span class="ust-stat-number">{{c.data.stats.backed_out || 0}}</span>
        <span class="ust-stat-label">Backed Out</span>
      </div>
    </div>
    <div class="ust-stat-card ust-stat-ignored" tabindex="0" role="button"
         ng-click="c.filterByState('ignore')" ng-keydown="c.handleKeyAction($event, 'ignore')"
         aria-label="Ignored: {{c.data.stats.ignore}}">
      <div class="ust-stat-icon">
        <i class="fa fa-ban" aria-hidden="true"></i>
      </div>
      <div class="ust-stat-content">
        <span class="ust-stat-number">{{c.data.stats.ignore || 0}}</span>
        <span class="ust-stat-label">Ignored</span>
      </div>
    </div>
  </div>

  <!-- Access Denied Message -->
  <div class="ust-access-denied" ng-if="c.data.accessDenied" role="alert">
    <i class="fa fa-lock fa-3x" aria-hidden="true"></i>
    <h2>Access Restricted</h2>
    <p>You do not have the required role to view update set migration data. Please contact your system administrator.</p>
  </div>

  <!-- Main Content -->
  <div ng-if="!c.data.accessDenied">
    <!-- Toolbar -->
    <div class="ust-toolbar" role="toolbar" aria-label="Filter and search controls">
      <div class="ust-search-group">
        <label for="ust-search-input" class="sr-only">Search update sets</label>
        <div class="ust-search-wrapper">
          <i class="fa fa-search ust-search-icon" aria-hidden="true"></i>
          <input type="text" id="ust-search-input" class="ust-search-input"
                 ng-model="c.searchTerm" ng-change="c.onSearchChange()"
                 placeholder="Search by name, description, or creator..."
                 aria-describedby="ust-search-hint" autocomplete="off" />
          <button class="ust-search-clear" ng-if="c.searchTerm"
                  ng-click="c.clearSearch()" aria-label="Clear search">
            <i class="fa fa-times" aria-hidden="true"></i>
          </button>
        </div>
        <span id="ust-search-hint" class="sr-only">Type to filter update sets in real-time</span>
      </div>

      <div class="ust-filter-group">
        <div class="ust-filter-item">
          <label for="ust-state-filter" class="ust-filter-label">Status</label>
          <select id="ust-state-filter" class="ust-select" ng-model="c.filters.state"
                  ng-change="c.applyFilters()" aria-label="Filter by status">
            <option value="">All States</option>
            <option value="in progress">In Progress</option>
            <option value="complete">Complete</option>
            <option value="backed out">Backed Out</option>
            <option value="ignore">Ignore</option>
          </select>
        </div>
        <div class="ust-filter-item">
          <label for="ust-date-from" class="ust-filter-label">From</label>
          <input type="date" id="ust-date-from" class="ust-date-input"
                 ng-model="c.filters.dateFrom" ng-change="c.applyFilters()"
                 aria-label="Filter from date" />
        </div>
        <div class="ust-filter-item">
          <label for="ust-date-to" class="ust-filter-label">To</label>
          <input type="date" id="ust-date-to" class="ust-date-input"
                 ng-model="c.filters.dateTo" ng-change="c.applyFilters()"
                 aria-label="Filter to date" />
        </div>
        <div class="ust-filter-item">
          <label for="ust-creator-filter" class="ust-filter-label">Creator</label>
          <select id="ust-creator-filter" class="ust-select" ng-model="c.filters.creator"
                  ng-change="c.applyFilters()" aria-label="Filter by creator">
            <option value="">All Creators</option>
            <option ng-repeat="creator in c.data.creators" value="{{creator}}">{{creator}}</option>
          </select>
        </div>
      </div>

      <div class="ust-action-group">
        <button class="ust-btn ust-btn-refresh" ng-click="c.refreshData()"
                ng-disabled="c.loading" aria-label="Refresh data">
          <i class="fa fa-refresh" ng-class="{'fa-spin': c.loading}" aria-hidden="true"></i>
          <span class="ust-btn-text">Refresh</span>
        </button>
        <button class="ust-btn ust-btn-export" ng-click="c.exportCSV()"
                ng-disabled="c.loading" aria-label="Export to CSV">
          <i class="fa fa-download" aria-hidden="true"></i>
          <span class="ust-btn-text">Export CSV</span>
        </button>
        <div class="ust-auto-refresh-toggle">
          <label class="ust-toggle-label">
            <input type="checkbox" ng-model="c.autoRefreshEnabled"
                   ng-change="c.toggleAutoRefresh()" aria-label="Toggle auto-refresh" />
            <span class="ust-toggle-slider"></span>
            <span class="ust-toggle-text">Auto-refresh</span>
          </label>
        </div>
      </div>
    </div>

    <!-- Loading indicator -->
    <div class="ust-loading-overlay" ng-if="c.loading" role="status" aria-live="polite">
      <div class="ust-spinner"></div>
      <span>Loading update sets...</span>
    </div>

    <!-- Error message -->
    <div class="ust-error-banner" ng-if="c.errorMessage" role="alert" aria-live="assertive">
      <i class="fa fa-exclamation-circle" aria-hidden="true"></i>
      <span>{{c.errorMessage}}</span>
      <button class="ust-error-dismiss" ng-click="c.dismissError()" aria-label="Dismiss error">
        <i class="fa fa-times" aria-hidden="true"></i>
      </button>
    </div>

    <!-- Results info -->
    <div class="ust-results-info" aria-live="polite">
      <span>Showing {{c.getFilteredCount()}} of {{c.data.updateSets.length}} update sets</span>
      <span ng-if="c.data.avgMigrationTime" class="ust-avg-time">
        <i class="fa fa-clock-o" aria-hidden="true"></i>
        Avg. migration time: {{c.data.avgMigrationTime}}
      </span>
    </div>

    <!-- Data Table -->
    <div class="ust-table-container" role="region" aria-label="Update sets table" tabindex="0">
      <table class="ust-table" role="grid" aria-label="Update Set Migration Data">
        <thead>
          <tr role="row">
            <th class="ust-th-expand" scope="col" aria-label="Expand row"></th>
            <th scope="col" class="ust-th-sortable" ng-click="c.sortBy('name')"
                ng-keydown="c.handleSortKey($event, 'name')" tabindex="0" role="columnheader"
                aria-sort="{{c.getSortAria('name')}}">
              <span>Name</span>
              <i class="fa" ng-class="c.getSortIcon('name')" aria-hidden="true"></i>
            </th>
            <th scope="col" class="ust-th-sortable" ng-click="c.sortBy('state')"
                ng-keydown="c.handleSortKey($event, 'state')" tabindex="0" role="columnheader"
                aria-sort="{{c.getSortAria('state')}}">
              <span>Status</span>
              <i class="fa" ng-class="c.getSortIcon('state')" aria-hidden="true"></i>
            </th>
            <th scope="col" class="ust-th-env">Environment Progress</th>
            <th scope="col" class="ust-th-sortable" ng-click="c.sortBy('sys_created_by')"
                ng-keydown="c.handleSortKey($event, 'sys_created_by')" tabindex="0" role="columnheader"
                aria-sort="{{c.getSortAria('sys_created_by')}}">
              <span>Creator</span>
              <i class="fa" ng-class="c.getSortIcon('sys_created_by')" aria-hidden="true"></i>
            </th>
            <th scope="col" class="ust-th-sortable" ng-click="c.sortBy('sys_created_on')"
                ng-keydown="c.handleSortKey($event, 'sys_created_on')" tabindex="0" role="columnheader"
                aria-sort="{{c.getSortAria('sys_created_on')}}">
              <span>Created</span>
              <i class="fa" ng-class="c.getSortIcon('sys_created_on')" aria-hidden="true"></i>
            </th>
            <th scope="col" class="ust-th-sortable" ng-click="c.sortBy('sys_updated_on')"
                ng-keydown="c.handleSortKey($event, 'sys_updated_on')" tabindex="0" role="columnheader"
                aria-sort="{{c.getSortAria('sys_updated_on')}}">
              <span>Modified</span>
              <i class="fa" ng-class="c.getSortIcon('sys_updated_on')" aria-hidden="true"></i>
            </th>
            <th scope="col" class="ust-th-sortable" ng-click="c.sortBy('update_count')"
                ng-keydown="c.handleSortKey($event, 'update_count')" tabindex="0" role="columnheader"
                aria-sort="{{c.getSortAria('update_count')}}">
              <span>Updates</span>
              <i class="fa" ng-class="c.getSortIcon('update_count')" aria-hidden="true"></i>
            </th>
            <th scope="col">Age</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr ng-repeat-start="us in c.filteredSets = (c.data.updateSets | filter:c.searchFilter | orderBy:c.sortField:c.sortReverse) track by us.sys_id"
              role="row" class="ust-row"
              ng-class="{'ust-row-expanded': c.expandedRows[us.sys_id], 'ust-row-conflict': us.hasConflicts}">
            <td class="ust-td-expand">
              <button class="ust-expand-btn" ng-click="c.toggleRow(us)"
                      aria-expanded="{{!!c.expandedRows[us.sys_id]}}"
                      aria-label="{{c.expandedRows[us.sys_id] ? 'Collapse' : 'Expand'}} details for {{us.name}}">
                <i class="fa" ng-class="c.expandedRows[us.sys_id] ? 'fa-chevron-down' : 'fa-chevron-right'"
                   aria-hidden="true"></i>
              </button>
            </td>
            <td class="ust-td-name">
              <span class="ust-name-text" title="{{us.name}}">{{us.name}}</span>
              <span class="ust-conflict-icon" ng-if="us.hasConflicts" title="Has conflicts">
                <i class="fa fa-warning" aria-hidden="true"></i>
                <span class="sr-only">Has conflicts</span>
              </span>
            </td>
            <td class="ust-td-status">
              <span class="ust-status-badge ust-status-{{c.getStatusClass(us.state)}}"
                    role="status" aria-label="Status: {{us.state}}">
                {{us.state}}
              </span>
            </td>
            <td class="ust-td-env">
              <div class="ust-env-progress" aria-label="Environment migration progress">
                <div class="ust-env-step" ng-class="{'ust-env-active': us.envStatus.dev}" title="Development">
                  <span class="ust-env-dot ust-env-dot-dev" ng-class="{'ust-env-dot-filled': us.envStatus.dev}"></span>
                  <span class="ust-env-label">DEV</span>
                </div>
                <div class="ust-env-connector" ng-class="{'ust-env-connector-active': us.envStatus.test}"></div>
                <div class="ust-env-step" ng-class="{'ust-env-active': us.envStatus.test}" title="Test">
                  <span class="ust-env-dot ust-env-dot-test" ng-class="{'ust-env-dot-filled': us.envStatus.test}"></span>
                  <span class="ust-env-label">TEST</span>
                </div>
                <div class="ust-env-connector" ng-class="{'ust-env-connector-active': us.envStatus.prod}"></div>
                <div class="ust-env-step" ng-class="{'ust-env-active': us.envStatus.prod}" title="Production">
                  <span class="ust-env-dot ust-env-dot-prod" ng-class="{'ust-env-dot-filled': us.envStatus.prod}"></span>
                  <span class="ust-env-label">PROD</span>
                </div>
              </div>
            </td>
            <td class="ust-td-creator">{{us.sys_created_by}}</td>
            <td class="ust-td-date">{{us.sys_created_on}}</td>
            <td class="ust-td-date">{{us.sys_updated_on}}</td>
            <td class="ust-td-count">
              <span class="ust-count-badge">{{us.update_count || 0}}</span>
            </td>
            <td class="ust-td-age">
              <span class="ust-age-badge ust-age-{{c.getAgePriority(us.sys_created_on)}}"
                    aria-label="Age: {{c.getAgeDays(us.sys_created_on)}} days">
                {{c.getAgeDays(us.sys_created_on)}}d
              </span>
            </td>
            <td class="ust-td-actions">
              <div class="ust-actions-menu">
                <button class="ust-action-btn ust-action-mark" ng-click="c.markForMigration(us)"
                        ng-if="us.state === 'in progress'"
                        title="Mark as Complete" aria-label="Mark {{us.name}} as complete">
                  <i class="fa fa-check" aria-hidden="true"></i>
                </button>
                <button class="ust-action-btn ust-action-approve" ng-click="c.requestApproval(us)"
                        ng-if="us.state === 'complete'"
                        title="Request Deployment Approval" aria-label="Request approval for {{us.name}}">
                  <i class="fa fa-paper-plane" aria-hidden="true"></i>
                </button>
                <button class="ust-action-btn ust-action-view" ng-click="c.viewDetails(us)"
                        title="View Details" aria-label="View details for {{us.name}}">
                  <i class="fa fa-eye" aria-hidden="true"></i>
                </button>
              </div>
            </td>
          </tr>
          <!-- Expanded detail row -->
          <tr ng-repeat-end ng-if="c.expandedRows[us.sys_id]" class="ust-detail-row">
            <td colspan="10">
              <div class="ust-detail-panel" role="region" aria-label="Details for {{us.name}}">
                <div class="ust-detail-loading" ng-if="c.loadingDetails[us.sys_id]">
                  <div class="ust-spinner-sm"></div>
                  <span>Loading details...</span>
                </div>
                <div ng-if="!c.loadingDetails[us.sys_id]">
                  <!-- Description -->
                  <div class="ust-detail-section">
                    <h4 class="ust-detail-heading">Description</h4>
                    <p class="ust-detail-desc">{{us.description || 'No description provided'}}</p>
                  </div>

                  <!-- Update XML Records -->
                  <div class="ust-detail-section">
                    <h4 class="ust-detail-heading">Update Records ({{us.xmlRecords.length || 0}})</h4>
                    <div class="ust-xml-grid" ng-if="us.xmlRecords.length > 0">
                      <div class="ust-xml-card" ng-repeat="xml in us.xmlRecords track by xml.sys_id">
                        <div class="ust-xml-type">
                          <span class="ust-xml-type-badge">{{xml.type}}</span>
                        </div>
                        <div class="ust-xml-info">
                          <span class="ust-xml-name" title="{{xml.target_name}}">{{xml.target_name}}</span>
                          <span class="ust-xml-action ust-xml-action-{{xml.action}}">{{xml.action}}</span>
                        </div>
                        <div class="ust-xml-meta">
                          <span>{{xml.sys_created_by}} - {{xml.sys_created_on}}</span>
                        </div>
                      </div>
                    </div>
                    <p ng-if="!us.xmlRecords || us.xmlRecords.length === 0" class="ust-no-data">
                      No update records found.
                    </p>
                  </div>

                  <!-- Update Types Summary -->
                  <div class="ust-detail-section" ng-if="us.typeSummary">
                    <h4 class="ust-detail-heading">Update Types Breakdown</h4>
                    <div class="ust-type-chips">
                      <span class="ust-type-chip" ng-repeat="(type, count) in us.typeSummary">
                        {{type}}: <strong>{{count}}</strong>
                      </span>
                    </div>
                  </div>

                  <!-- Migration Timeline -->
                  <div class="ust-detail-section" ng-if="us.migrationHistory && us.migrationHistory.length > 0">
                    <h4 class="ust-detail-heading">Migration Timeline</h4>
                    <div class="ust-timeline">
                      <div class="ust-timeline-item" ng-repeat="event in us.migrationHistory track by $index">
                        <div class="ust-timeline-dot" ng-class="'ust-timeline-dot-' + event.status"></div>
                        <div class="ust-timeline-content">
                          <span class="ust-timeline-date">{{event.date}}</span>
                          <span class="ust-timeline-desc">{{event.description}}</span>
                          <span class="ust-timeline-state ust-status-badge ust-status-{{c.getStatusClass(event.status)}}">
                            {{event.status}}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Conflicts -->
                  <div class="ust-detail-section" ng-if="us.conflicts && us.conflicts.length > 0">
                    <h4 class="ust-detail-heading ust-heading-warning">
                      <i class="fa fa-warning" aria-hidden="true"></i>
                      Conflicts & Warnings ({{us.conflicts.length}})
                    </h4>
                    <div class="ust-conflict-list">
                      <div class="ust-conflict-item" ng-repeat="conflict in us.conflicts track by $index">
                        <i class="fa fa-exclamation-circle" aria-hidden="true"></i>
                        <div class="ust-conflict-info">
                          <span class="ust-conflict-desc">{{conflict.description}}</span>
                          <span class="ust-conflict-type">Type: {{conflict.type}} | Status: {{conflict.status}}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Empty state -->
      <div class="ust-empty-state" ng-if="c.filteredSets.length === 0 && !c.loading">
        <i class="fa fa-inbox fa-3x" aria-hidden="true"></i>
        <h3>No Update Sets Found</h3>
        <p>Try adjusting your filters or search criteria.</p>
        <button class="ust-btn ust-btn-reset" ng-click="c.resetFilters()">Reset Filters</button>
      </div>
    </div>

    <!-- Pagination -->
    <div class="ust-pagination" role="navigation" aria-label="Pagination"
         ng-if="c.data.totalPages > 1">
      <button class="ust-page-btn" ng-click="c.goToPage(1)"
              ng-disabled="c.data.currentPage === 1" aria-label="First page">
        <i class="fa fa-angle-double-left" aria-hidden="true"></i>
      </button>
      <button class="ust-page-btn" ng-click="c.goToPage(c.data.currentPage - 1)"
              ng-disabled="c.data.currentPage === 1" aria-label="Previous page">
        <i class="fa fa-angle-left" aria-hidden="true"></i>
      </button>
      <span class="ust-page-info" aria-live="polite">
        Page {{c.data.currentPage}} of {{c.data.totalPages}}
      </span>
      <button class="ust-page-btn" ng-click="c.goToPage(c.data.currentPage + 1)"
              ng-disabled="c.data.currentPage === c.data.totalPages" aria-label="Next page">
        <i class="fa fa-angle-right" aria-hidden="true"></i>
      </button>
      <button class="ust-page-btn" ng-click="c.goToPage(c.data.totalPages)"
              ng-disabled="c.data.currentPage === c.data.totalPages" aria-label="Last page">
        <i class="fa fa-angle-double-right" aria-hidden="true"></i>
      </button>
    </div>

    <!-- Last refresh timestamp -->
    <div class="ust-footer-info" aria-live="polite">
      <span ng-if="c.lastRefreshed">Last refreshed: {{c.lastRefreshed}}</span>
      <span ng-if="c.autoRefreshEnabled" class="ust-auto-indicator">
        <i class="fa fa-circle ust-pulse" aria-hidden="true"></i> Auto-refreshing every 60s
      </span>
    </div>
  </div>
</div>]]></template>
<u_search_keys/>
</sp_widget>
</unload>
